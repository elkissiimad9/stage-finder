<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>PFE Stage Finder — Stages & CV Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Stages PFE (Tech, Marketing, Finance, Logistique, Commerce, Droit). Dépôt CV, matching, espace recruteur, note CV." />
  <meta name="robots" content="index,follow" />
  <meta property="og:title" content="PFE Stage Finder — Stages & CV Coach" />
  <meta property="og:description" content="Stages PFE + dépôt CV + matching + espace recruteur + note CV." />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.7);
      --brand:#2dd4bf;   /* menthe/teal */
      --brand-2:#34d399; /* émeraude */
      --chip:rgba(255,255,255,.08);
    }
    body{ color:var(--text); background: radial-gradient(1200px 800px at 10% -10%, rgba(45,212,191,.18), transparent 40%), radial-gradient(900px 700px at 110% 20%, rgba(52,211,153,.14), transparent 50%), var(--bg); }
    .glass{ background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); backdrop-filter: blur(8px); border:1px solid var(--stroke); }
    .btn{ border-radius:14px; padding:10px 14px; border:1px solid var(--stroke); background:var(--chip); transition:.2s transform, .2s background; }
    .btn:hover{ background:rgba(255,255,255,.12); transform: translateY(-1px); }
    .btn-emerald{ background:var(--brand); color:#062a25; border:none; }
    .btn-emerald:hover{ filter:brightness(1.06); transform: translateY(-1px); }
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--chip); transition:.2s; }
    .chip[data-active="true"]{ background: var(--brand); color:#072d29; border-color:var(--brand); box-shadow:0 6px 18px rgba(45,212,191,.25); }
    .badge{ font-size:11px; padding:4px 8px; border-radius:9px; border:1px solid var(--stroke); background:var(--chip); }
    .card{ border-radius:22px; border:1px solid var(--stroke); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04)); transition:.25s transform, .25s box-shadow; }
    .card:hover{ transform: translateY(-4px); box-shadow:0 18px 45px rgba(0,0,0,.35); }
    .meter{ height:8px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden; }
    .meter > i{ display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--brand-2)); }

    /* Aurora hero (remplace le grand tableau) */
    .aurora{
      position: relative; border-radius:26px; overflow:hidden;
      border:1px solid var(--stroke);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(45,212,191,.22), transparent 40%),
        radial-gradient(900px 580px at 90% 70%, rgba(52,211,153,.20), transparent 50%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .blob, .blob2{
      position:absolute; inset:auto; width:32rem; height:32rem; border-radius:999px;
      filter: blur(38px); opacity:.35; pointer-events:none;
      animation: float 16s ease-in-out infinite;
      background: radial-gradient(circle at 30% 30%, rgba(45,212,191,.35), transparent 55%);
    }
    .blob2{ width:26rem; height:26rem; right:-10%; bottom:-15%; animation: float2 18s ease-in-out infinite; background: radial-gradient(circle at 60% 40%, rgba(52,211,153,.32), transparent 55%);}
    @keyframes float{ 0%,100%{ transform: translate(-10%,-10%) } 50%{ transform: translate(10%, 5%) } }
    @keyframes float2{ 0%,100%{ transform: translate(5%,10%) } 50%{ transform: translate(-10%,-5%) } }

    /* Small tilt */
    .tilt{ transform-style:preserve-3d; }
    .tilt:hover{ transform: perspective(900px) rotateX(2deg) rotateY(-2deg); }

    /* subtle scrollbars */
    ::-webkit-scrollbar{ height:10px; width:10px; }
    ::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.18); border-radius:20px; }
  </style>
</head>
<body class="min-h-screen">

  <!-- NAV -->
  <header class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl grid place-items-center text-[var(--brand)] font-bold glass">P</div>
      <span class="font-semibold tracking-wide">PFE Stage Finder</span>
    </div>
    <nav class="hidden md:flex items-center gap-6 text-sm text-[var(--muted)]">
      <a href="#jobs" class="hover:text-white">Stages</a>
      <a href="#cvcoach" class="hover:text-white">CV Coach</a>
      <a href="#candidat" class="hover:text-white">Espace Candidat</a>
      <a href="#recruteur" class="hover:text-white">Espace Recruteur</a>
      <a href="#how" class="hover:text-white">Comment ça marche</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="max-w-7xl mx-auto px-6 pt-2 md:pt-6">
    <div class="grid md:grid-cols-2 gap-10 items-center">
      <div class="tilt">
        <h1 class="text-4xl md:text-6xl font-semibold leading-tight">
          Trouve ton <span style="color:var(--brand)">Stage PFE</span> idéal.
        </h1>
        <p class="mt-4 text-[var(--muted)] max-w-prose">
          Dépose ton CV, découvre des offres et postule en 1 clic. Les recruteurs publient,
          filtrent et sélectionnent facilement les meilleurs profils.
        </p>

        <!-- search -->
        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <input id="q" placeholder="Marketing, Finance, Logistique, Commerce, Droit, Tech..."
                 class="flex-1 rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3 outline-none focus:ring-2 focus:ring-[var(--brand)]/60" />
          <button class="btn-emerald rounded-xl px-5 py-3 font-semibold" onclick="searchJobs()">
            Rechercher
          </button>
        </div>

        <!-- categories -->
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="chip" data-cat="Tous" onclick="setCat(this)">Tous</button>
          <button class="chip" data-cat="Tech" onclick="setCat(this)">Tech</button>
          <button class="chip" data-cat="Marketing" onclick="setCat(this)">Marketing</button>
          <button class="chip" data-cat="Finance" onclick="setCat(this)">Finance</button>
          <button class="chip" data-cat="Logistique" onclick="setCat(this)">Logistique</button>
          <button class="chip" data-cat="Commerce" onclick="setCat(this)">Commerce</button>
          <button class="chip" data-cat="Droit" onclick="setCat(this)">Droit</button>
        </div>

        <!-- CV upload (nom + tips détectés) -->
        <label class="mt-5 block rounded-2xl glass p-4 cursor-pointer">
          <div class="flex items-center justify-between gap-4">
            <div class="text-sm">
              <div class="font-medium">Déposer ton CV (texte recommandé)</div>
              <div class="text-[var(--muted)]">Colle ton CV dans “CV Coach” pour l’analyse & la note.</div>
            </div>
            <div class="shrink-0 btn">Choisir un fichier</div>
          </div>
          <input id="cvfile" type="file" accept=".pdf,.doc,.docx,.txt" class="hidden" onchange="onPickCV(event)" />
        </label>
        <div id="cvInfo" class="mt-3 text-sm text-[var(--muted)] hidden">
          CV chargé: <span id="cvName" class="text-white"></span>
          <span id="cvSkills" class="ml-3"></span>
        </div>

        <div class="mt-6 flex flex-wrap gap-2">
          <span class="badge">Matching CV</span>
          <span class="badge">Agrégation locale</span>
          <span class="badge">Filtrage catégories</span>
          <span class="badge">Candidature 1-clic</span>
        </div>
      </div>

      <!-- Aurora / KPI (remplace l’ancien “grand tableau”) -->
      <div class="aurora p-6 tilt">
        <div class="grid grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4">
            <div class="text-sm text-[var(--muted)]">Offres actives</div>
            <div id="kpiJobs" class="text-3xl font-semibold mt-1">—</div>
            <div class="meter mt-3"><i style="width:70%"></i></div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-sm text-[var(--muted)]">Candidatures</div>
            <div id="kpiApps" class="text-3xl font-semibold mt-1">—</div>
            <div class="meter mt-3"><i style="width:55%"></i></div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-sm text-[var(--muted)]">Recruteurs</div>
            <div id="kpiRecruiters" class="text-3xl font-semibold mt-1">—</div>
            <div class="meter mt-3"><i style="width:62%"></i></div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-sm text-[var(--muted)]">Taux de match moyen</div>
            <div id="kpiMatch" class="text-3xl font-semibold mt-1">—</div>
            <div class="meter mt-3"><i style="width:48%"></i></div>
          </div>
        </div>
        <div class="blob"></div><div class="blob2"></div>
      </div>
    </div>
  </section>

  <!-- JOBS -->
  <section id="jobs" class="max-w-7xl mx-auto px-6 pb-16 pt-10">
    <div class="flex items-end justify-between">
      <h2 class="text-xl md:text-2xl font-semibold">Stages recommandés</h2>
      <div id="resultsCount" class="text-sm text-[var(--muted)]">—</div>
    </div>
    <div id="jobList" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
  </section>

  <!-- CV COACH -->
  <section id="cvcoach" class="max-w-7xl mx-auto px-6 pb-20">
    <div class="rounded-2xl glass p-5">
      <div class="flex items-center justify-between gap-3">
        <h3 class="text-lg font-semibold">CV Coach — Analyse & Amélioration</h3>
        <div id="cvScoreWrap" class="hidden items-center gap-2 text-sm">
          <span class="text-[var(--muted)]">Note CV</span>
          <div id="cvScoreBadge" class="min-w-14 text-center font-semibold text-black bg-[var(--brand)] rounded-md px-2 py-1">0/100</div>
        </div>
      </div>
      <p class="mt-2 text-[var(--muted)] text-sm">Colle le texte brut de ton CV ci-dessous (ou exporte en .txt) pour une analyse compatible ATS.</p>
      <textarea id="cvText" rows="8" placeholder="Colle ici le contenu texte de ton CV..." class="mt-3 w-full rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3 outline-none focus:ring-2 focus:ring-[var(--brand)]/60"></textarea>
      <div class="mt-3 flex items-center gap-3">
        <button onclick="analyzeCv()" class="btn-emerald rounded-xl px-4 py-2 font-semibold">Analyser mon CV</button>
        <div id="cvQuality" class="text-[var(--muted)] text-sm"></div>
      </div>
      <ul id="cvTips" class="mt-4 grid sm:grid-cols-2 gap-2 text-sm text-[var(--muted)] list-disc pl-5"></ul>
    </div>
  </section>

  <!-- ESPACE CANDIDAT -->
  <section id="candidat" class="max-w-7xl mx-auto px-6 pb-20">
    <h2 class="text-xl md:text-2xl font-semibold">Espace Candidat</h2>
    <div class="grid md:grid-cols-2 gap-6 mt-4">
      <div class="rounded-2xl glass p-5">
        <h3 class="font-semibold mb-2">Mon profil</h3>
        <div class="grid gap-3">
          <input id="cand_name" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Nom complet" />
          <input id="cand_headline" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Titre (ex: Étudiant Data / Marketing)" />
          <input id="cand_skills" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Compétences (séparées par des virgules)" />
          <input id="cand_location" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Ville (ex: Rabat)" />
          <textarea id="cand_cvtext" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" rows="5" placeholder="Colle ici ton CV (texte) pour que les recruteurs puissent le lire"></textarea>
          <button class="btn-emerald font-semibold w-max" onclick="saveCandidate()">Enregistrer mon profil</button>
        </div>
      </div>

      <div class="rounded-2xl glass p-5">
        <h3 class="font-semibold mb-2">Aperçu — Mon profil</h3>
        <div id="candPreview" class="text-[var(--muted)] text-sm">Aucun profil enregistré.</div>
      </div>
    </div>
  </section>

  <!-- ESPACE RECRUTEUR -->
  <section id="recruteur" class="max-w-7xl mx-auto px-6 pb-24">
    <h2 class="text-xl md:text-2xl font-semibold">Espace Recruteur</h2>

    <!-- Publier -->
    <div class="rounded-2xl glass p-5 mt-4">
      <h3 class="font-semibold mb-2">Publier un stage</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <input id="job_title" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Titre du stage (ex: Stage Marketing Digital)" />
        <select id="job_cat" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3">
          <option>Tech</option><option>Marketing</option><option>Finance</option>
          <option>Logistique</option><option>Commerce</option><option>Droit</option>
        </select>
        <input id="job_company" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Entreprise (ex: Atlas Corp)" />
        <input id="job_location" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3" placeholder="Ville / Remote" />
        <input id="job_tags" class="rounded-xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3 md:col-span-2" placeholder="Compétences requises (ex: SEO, Excel, React) séparées par des virgules" />
        <textarea id="job_desc" class="rounded-2xl bg-[rgba(255,255,255,.06)] border border-[var(--stroke)] px-4 py-3 md:col-span-2" rows="5" placeholder="Description du stage"></textarea>
      </div>
      <button class="btn-emerald font-semibold mt-3" onclick="publishJob()">Publier le stage</button>
    </div>

    <!-- Mes offres + candidatures + matching -->
    <div class="grid gap-6 mt-6" id="recruiterJobs"></div>
  </section>

  <!-- FOOTER -->
  <footer class="border-t border-[var(--stroke)] glass">
    <div class="max-w-7xl mx-auto px-6 py-8 flex flex-col sm:flex-row items-center justify-between gap-4 text-sm text-[var(--muted)]">
      <div>© <span id="year"></span> PFE Stage Finder</div>
      <div class="flex gap-4">
        <a class="hover:text-white" href="#candidat">Candidat</a>
        <a class="hover:text-white" href="#recruteur">Recruteur</a>
        <a class="hover:text-white" href="#cvcoach">CV Coach</a>
      </div>
    </div>
  </footer>

<script>
/* ========= Données (localStorage) ========= */
const DB = {
  get jobs() { return JSON.parse(localStorage.getItem('jobs') || '[]'); },
  set jobs(v) { localStorage.setItem('jobs', JSON.stringify(v)); },
  get candidate() { return JSON.parse(localStorage.getItem('candidate') || 'null'); },
  set candidate(v) { localStorage.setItem('candidate', JSON.stringify(v)); },
  get applications() { return JSON.parse(localStorage.getItem('applications') || '[]'); },
  set applications(v) { localStorage.setItem('applications', JSON.stringify(v)); }
};

// seed si vide
(function seed(){
  if(DB.jobs.length) return;
  DB.jobs = [
    j("Stage PFE – Data Analyst (Python, SQL)","TechNova Analytics","Casablanca (Hybrid)","Analyse de données, dashboards, KPI.",["Python","SQL","Power BI"],"Tech",10),
    j("Stage PFE – Marketing Digital (SEO/Content)","MarocMarket","Casablanca","Calendrier éditorial, SEO on-page, Analytics.",["Marketing","SEO","Social Media"],"Marketing",6),
    j("Stage PFE – Finance (Contrôle de gestion)","Atlas Finance","Rabat","KPIs, analyse des écarts, prévisions.",["Finance","Excel","Power BI"],"Finance",5),
    j("Stage PFE – Logistique (Supply Chain)","Tangier Logistics","Tanger","Optimisation des flux, inventaires, transport.",["Logistique","Supply Chain","ERP"],"Logistique",4),
    j("Stage PFE – Commerce (Business Dev)","Sahara Trade","Fès","Prospection B2B, CRM, supports commerciaux.",["Commerce","Vente","Prospection"],"Commerce",3),
    j("Stage PFE – Droit (Contrats & Conformité)","LegalAtlas","Casablanca","Revue contractuelle, conformité.",["Droit","Contrats","RGPD"],"Droit",7),
  ];
  function j(title,company,location,description,tags,category,ago){
    return { id: uid(), title, company, location, description, tags, category, postedAt: dateStr(daysAgo(ago)) };
  }
})();

/* ========= Utilitaires ========= */
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d; }
function dateStr(d){ return new Date(d).toLocaleDateString(); }
function text(t){ return (t||"").toString(); }
function lower(s){ return text(s).toLowerCase(); }
function tokenizeSkills(s){ return text(s).split(",").map(x=>x.trim()).filter(Boolean); }

/* ========= État ========= */
let ACTIVE_CAT="Tous", QUERY="", CURRENT_CV_NAME="", CURRENT_CV_TEXT="";

/* ========= UI: KPIs ========= */
function updateKPIs(){
  document.getElementById('kpiJobs').textContent = DB.jobs.length;
  document.getElementById('kpiApps').textContent = DB.applications.length;
  document.getElementById('kpiRecruiters').textContent = Math.max(1, Math.ceil(DB.jobs.length/2)); // approx démo
  // match moyen
  const scores = DB.jobs.map(scoreForJob);
  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;
  document.getElementById('kpiMatch').textContent = avg+"%";
}

/* ========= Recherche / Catégories ========= */
function setCat(btn){
  ACTIVE_CAT = btn.getAttribute('data-cat');
  document.querySelectorAll('[data-cat]').forEach(b=>{
    b.dataset.active = (b===btn) ? "true" : "false";
  });
  renderJobs();
}
function searchJobs(){
  QUERY = document.getElementById('q').value.trim().toLowerCase();
  renderJobs();
}

/* ========= CV Upload ========= */
function onPickCV(e){
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  CURRENT_CV_NAME = file.name;
  document.getElementById('cvName').textContent = file.name;
  const hints=[], low=file.name.toLowerCase();
  ["python","sql","react","docker","marketing","finance","logistique","commerce","droit"].forEach(k=>{ if(low.includes(k)) hints.push(cap(k)); });
  document.getElementById('cvSkills').textContent = hints.length? `Compétences détectées: ${hints.join(", ")}` : "";
  document.getElementById('cvInfo').classList.remove('hidden');
}
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* ========= CV Coach ========= */
function analyzeCv(){
  const t = document.getElementById('cvText').value || "";
  CURRENT_CV_TEXT = t;
  const res = scoreCv(t);
  document.getElementById('cvScoreWrap').classList.remove('hidden');
  document.getElementById('cvScoreBadge').textContent = res.score + "/100";
  document.getElementById('cvQuality').textContent =
    res.score>=80 ? "Qualité estimée : Excellente" :
    res.score>=65 ? "Qualité estimée : Bonne" :
    res.score>=50 ? "Qualité estimée : Moyenne" : "Qualité estimée : À améliorer";
  const tipsEl = document.getElementById('cvTips'); tipsEl.innerHTML = "";
  res.tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tipsEl.appendChild(li); });
}
function scoreCv(text){
  const t = text.toLowerCase();
  const hasContact = /@|email|linkedin|t[ée]l|phone/.test(t);
  const sections = ["expérience","experience","formation","education","compétence","skills","projet","projects","certif"].filter(k=>t.includes(k)).length;
  const bullets = (text.match(/[•\-–]\s/g) || []).length;
  const numbers = (text.match(/\b\d+\b/g) || []).length;
  const lengthOk = text.length>=1200 && text.length<=8000;
  let score = 50;
  if (hasContact) score+=8;
  score += Math.min(20, sections*4);
  score += Math.min(10, Math.floor(bullets/5)*2);
  score += Math.min(8, Math.floor(numbers/5)*2);
  if (lengthOk) score+=6;
  score = Math.max(0, Math.min(100, score));
  const tips=[];
  if(!hasContact) tips.push("Ajoute un email et un LinkedIn visibles en haut.");
  if(sections<3) tips.push("Structure : Expérience, Formation, Compétences, Projets.");
  if(bullets<6) tips.push("Utilise des puces courtes (•) pour faciliter la lecture.");
  if(numbers<3) tips.push("Quantifie tes résultats (%/délais/budgets/#).");
  if(!lengthOk) tips.push("1 page (junior) ou 2 pages max (confirmé).");
  tips.push("Évite tableaux/boîtes de texte — reste compatible ATS.");
  return {score, tips};
}

/* ========= CANDIDAT ========= */
function saveCandidate(){
  const cand = {
    full_name: text(document.getElementById('cand_name').value),
    headline : text(document.getElementById('cand_headline').value),
    skills   : tokenizeSkills(document.getElementById('cand_skills').value),
    location : text(document.getElementById('cand_location').value),
    cv_text  : text(document.getElementById('cand_cvtext').value)
  };
  DB.candidate = cand;
  renderCandidate(); updateKPIs();
  alert("Profil candidat enregistré ✅");
}
function renderCandidate(){
  const c = DB.candidate;
  const el = document.getElementById('candPreview');
  if(!c){ el.textContent="Aucun profil enregistré."; return; }
  el.innerHTML = `
    <div class="font-semibold">${escapeHtml(c.full_name || "—")}</div>
    <div class="text-sm text-[var(--muted)]">${escapeHtml(c.headline || "")}</div>
    <div class="text-sm mt-1">${(c.skills||[]).map(s=>`<span class="badge mr-1">${escapeHtml(s)}</span>`).join(" ")}</div>
    <div class="text-xs text-[var(--muted)] mt-1">${escapeHtml(c.location || "")}</div>
    <details class="mt-2">
      <summary class="text-[var(--brand)] text-sm cursor-pointer">Voir le CV (texte)</summary>
      <pre class="mt-2 text-xs whitespace-pre-wrap">${escapeHtml(c.cv_text||"")}</pre>
    </details>
  `;
}

/* ========= RECRUTEUR ========= */
function publishJob(){
  const title = text(document.getElementById('job_title').value);
  const category = text(document.getElementById('job_cat').value);
  const company = text(document.getElementById('job_company').value);
  const location = text(document.getElementById('job_location').value);
  const tags = tokenizeSkills(document.getElementById('job_tags').value);
  const description = text(document.getElementById('job_desc').value);
  if(!title || !company){ alert("Titre et entreprise sont obligatoires."); return; }
  const job = { id: uid(), title, category, company, location, tags, description, postedAt: dateStr(new Date()) };
  const all = DB.jobs; all.unshift(job); DB.jobs = all;
  renderJobs(); renderRecruiter(); updateKPIs();
  document.getElementById('job_title').value="";
  document.getElementById('job_company').value="";
  document.getElementById('job_location').value="";
  document.getElementById('job_tags').value="";
  document.getElementById('job_desc').value="";
  alert("Stage publié ✅");
}

function renderRecruiter(){
  const wrap = document.getElementById('recruiterJobs');
  const jobs = DB.jobs;
  wrap.innerHTML = "";
  jobs.forEach(job=>{
    const apps = DB.applications.filter(a=>a.jobId===job.id);
    const matches = suggestCandidates(job);
    const card = document.createElement('div');
    card.className = "card p-5";
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">${escapeHtml(job.title)}</div>
          <div class="text-sm text-[var(--muted)]">${escapeHtml(job.category)} · ${escapeHtml(job.location||"")}</div>
          <div class="mt-1 text-sm">${(job.tags||[]).map(t=>`<span class="badge mr-1">${escapeHtml(t)}</span>`).join("")}</div>
        </div>
        <div class="text-xs text-[var(--muted)]">Publiée le ${escapeHtml(job.postedAt)}</div>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-6">
        <div>
          <div class="text-[var(--brand)] text-sm mb-2">Candidatures reçues</div>
          <div class="grid gap-3" id="apps-${job.id}">
            ${apps.map(a=>renderAppHTML(a)).join("") || `<div class="text-sm text-[var(--muted)]">Aucune candidature pour le moment.</div>`}
          </div>
        </div>

        <div>
          <div class="text-[var(--brand)] text-sm mb-2">Profils suggérés (match)</div>
          <div class="grid gap-3">
            ${matches.map(c=>`
              <div class="rounded-xl border border-[var(--stroke)] p-3">
                <div class="font-medium">${escapeHtml(c.full_name||"—")}</div>
                <div class="text-xs text-[var(--muted)]">${escapeHtml(c.location||"")}</div>
                <div class="text-sm mt-1">${(c.skills||[]).map(s=>`<span class="badge mr-1">${escapeHtml(s)}</span>`).join("")}</div>
                <div class="mt-2 text-xs text-[var(--muted)]">Score: ${c._score}</div>
              </div>
            `).join("") || `<div class="text-sm text-[var(--muted)]">Aucun profil correspondant.</div>`}
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });
}
function renderAppHTML(a){
  const c = a.candidate||{};
  return `
    <div class="rounded-xl border border-[var(--stroke)] p-3">
      <div class="font-medium">${escapeHtml(c.full_name||"—")}</div>
      <div class="text-sm text-[var(--muted)]">${(c.skills||[]).join(", ")}</div>
      <details class="mt-1"><summary class="text-[var(--brand)] text-xs cursor-pointer">Voir CV</summary>
        <pre class="mt-2 text-xs whitespace-pre-wrap">${escapeHtml(c.cv_text||"")}</pre>
      </details>
      <div class="mt-2 flex gap-2">
        <button class="text-xs btn" onclick="updateApp('${a.id}','shortlisted')">Shortlister</button>
        <button class="text-xs btn-emerald" onclick="updateApp('${a.id}','hired')">Embaucher</button>
      </div>
      <div class="text-xs text-[var(--muted)] mt-1">Statut: ${escapeHtml(a.status)}</div>
    </div>
  `;
}
function updateApp(appId, status){
  const arr = DB.applications.map(a => a.id===appId ? {...a, status} : a);
  DB.applications = arr;
  renderRecruiter(); updateKPIs();
}

/* ========= Postuler ========= */
function applyTo(jobId){
  const cand = DB.candidate;
  if(!cand){ alert("Crée d'abord ton profil candidat (section 'Espace Candidat')."); return; }
  const exists = DB.applications.some(a=>a.jobId===jobId && a.candidate && a.candidate.full_name===cand.full_name);
  if(exists){ alert("Tu as déjà postulé à cette offre."); return; }
  const app = { id: uid(), jobId, candidate: cand, status: "submitted", createdAt: new Date().toISOString() };
  const all = DB.applications; all.unshift(app); DB.applications = all;
  alert("Candidature envoyée ✅");
  renderRecruiter(); updateKPIs();
}

/* ========= Matching simple ========= */
function suggestCandidates(job){
  const c = DB.candidate;
  if(!c) return [];
  const need = (job.tags||[]).map(x=>lower(x));
  const have = (c.skills||[]).map(x=>lower(x));
  const s = have.filter(k=>need.includes(k)).length;
  if(!s) return [];
  return [{...c, _score: s}];
}

/* ========= Liste des offres ========= */
function renderJobs(){
  const wrap = document.getElementById('jobList');
  const jobs = DB.jobs.filter(j=>{
    const textHit = lower(j.title).includes(QUERY) || lower(j.description).includes(QUERY) || (j.tags||[]).some(t=>lower(t).includes(QUERY));
    const catHit = (ACTIVE_CAT==="Tous") ? true : j.category===ACTIVE_CAT;
    return textHit && catHit;
  });
  document.getElementById('resultsCount').textContent = `${jobs.length} résultats`;
  wrap.innerHTML = "";
  jobs.forEach(job=>{
    const matchScore = scoreForJob(job);
    const card = document.createElement('div');
    card.className = "card p-4";
    card.innerHTML = `
      <div class="flex items-center justify-between gap-3">
        <div class="font-medium leading-tight">${escapeHtml(job.title)}</div>
        <span class="badge">${escapeHtml(job.category||"—")}</span>
      </div>
      <div class="mt-1 text-sm">${escapeHtml(job.company||"")}</div>
      <div class="text-xs text-[var(--muted)]">${escapeHtml(job.location||"")}</div>
      <div class="mt-3 flex flex-wrap gap-1.5">
        ${(job.tags||[]).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join("")}
      </div>
      <p class="mt-3 text-sm text-[var(--muted)]">${escapeHtml(job.description||"")}</p>
      ${(CURRENT_CV_NAME || CURRENT_CV_TEXT) ? `
        <div class="mt-4">
          <div class="flex items-center justify-between text-xs text-[var(--muted)] mb-1">
            <span>Score de correspondance</span>
            <span class="text-white">${matchScore}%</span>
          </div>
          <div class="meter"><i style="width:${matchScore}%"></i></div>
        </div>` : ""
      }
      <div class="mt-4 flex gap-2">
        <button class="btn text-sm" onclick="applyTo('${job.id}')">Postuler</button>
      </div>
      <div class="mt-3 text-xs text-[var(--muted)]">Publié le ${escapeHtml(job.postedAt||"récemment")}</div>
    `;
    wrap.appendChild(card);
  });
}

/* ========= Score job ========= */
function scoreForJob(job){
  const bag = (CURRENT_CV_NAME + " " + CURRENT_CV_TEXT).toLowerCase();
  let s = 40;
  (job.tags||[]).forEach(t=>{ if(bag.includes(lower(t))) s+=10; });
  if (ACTIVE_CAT!=="Tous" && job.category===ACTIVE_CAT) s+=8;
  return Math.max(20, Math.min(98, s));
}

/* ========= Sécurité (échappement) ========= */
function escapeHtml(str){
  return text(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* ========= INIT ========= */
document.getElementById('year').textContent = new Date().getFullYear();
renderJobs(); renderRecruiter(); renderCandidate(); setCat(document.querySelector('[data-cat="Tous"]')); updateKPIs();
</script>
</body>
</html>
